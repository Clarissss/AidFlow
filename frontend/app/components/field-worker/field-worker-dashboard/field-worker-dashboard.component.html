<div class="field-worker-dashboard">
  <!-- Header -->
  <header class="dashboard-header">
    <div class="header-content">
      <h1>AidFlow - Dashboard Lapangan</h1>
      <div class="header-actions">
        <span class="user-info">Selamat datang, {{ currentUser?.name }}</span>
        <button class="btn btn-logout" (click)="logout()">Logout</button>
      </div>
    </div>
  </header>

  <div class="dashboard-content">
    <!-- Request Form Section -->
    <div class="section-card">
      <div class="section-header">
        <h2>Permintaan Bantuan</h2>
        <div class="header-buttons">
          <button class="btn btn-primary" (click)="toggleRequestForm()">
            {{ showRequestForm ? 'Batal' : '+ Request Barang yang Ada' }}
          </button>
          <button class="btn btn-secondary" (click)="toggleNewItemForm()">
            {{ showNewItemForm ? 'Batal' : '+ Request Barang Baru' }}
          </button>
        </div>
      </div>

      <!-- Request Form (Barang yang sudah ada) -->
      <div *ngIf="showRequestForm" class="request-form">
        <h3>Pilih Barang yang Dibutuhkan (dari Inventory)</h3>
        
        <div class="inventory-list">
          <div *ngFor="let item of inventory" class="inventory-item">
            <div class="item-info">
              <div>
                <strong>{{ item.name }}</strong>
                <span class="item-category">{{ item.category }}</span>
              </div>
              <div class="item-stock">
                Stok: <strong>{{ item.quantity }} {{ item.unit }}</strong>
              </div>
            </div>
            <div class="item-request">
              <input 
                type="number" 
                [value]="selectedItems.get(item.id) || 0"
                (change)="addItemToRequest(item, +$any($event.target).value)"
                min="0"
                [max]="item.quantity"
                class="quantity-input"
                placeholder="0"
              />
              <span class="unit">{{ item.unit }}</span>
              <button 
                *ngIf="selectedItems.has(item.id)"
                class="btn btn-danger btn-sm"
                (click)="removeItemFromRequest(item.id)"
              >
                Hapus
              </button>
            </div>
          </div>
        </div>

        <div *ngIf="inventory.length === 0" class="empty-state">
          Belum ada barang tersedia
        </div>

        <div *ngIf="getSelectedItemsCount() > 0" class="selected-summary">
          <h4>Barang yang Dipilih ({{ getSelectedItemsCount() }}):</h4>
          <ul>
            <li *ngFor="let entry of selectedItems | keyvalue">
              {{ getItemName(entry.key) }} - {{ entry.value }} {{ getItemUnit(entry.key) }}
            </li>
          </ul>
        </div>

        <div class="form-actions">
          <button class="btn btn-secondary" (click)="toggleRequestForm()">Batal</button>
          <button 
            class="btn btn-primary" 
            (click)="submitRequest()"
            [disabled]="getSelectedItemsCount() === 0"
          >
            Kirim Permintaan
          </button>
        </div>
      </div>

      <!-- New Item Request Form (Barang baru) -->
      <div *ngIf="showNewItemForm" class="request-form">
        <h3>Request Barang Baru yang Belum Ada di Inventory</h3>
        
        <div class="form-grid">
          <div class="form-group">
            <label>Nama Barang *</label>
            <input type="text" [(ngModel)]="newItemRequest.itemName" placeholder="Contoh: Generator Listrik" />
          </div>

          <div class="form-group">
            <label>Kategori *</label>
            <input type="text" [(ngModel)]="newItemRequest.category" placeholder="Contoh: Peralatan" />
          </div>

          <div class="form-group">
            <label>Jumlah yang Dibutuhkan *</label>
            <input type="number" [(ngModel)]="newItemRequest.requestedQuantity" min="1" />
          </div>

          <div class="form-group">
            <label>Satuan *</label>
            <input type="text" [(ngModel)]="newItemRequest.unit" placeholder="buah, unit, paket, dll" />
          </div>

          <div class="form-group full-width">
            <label>Deskripsi / Alasan Kebutuhan</label>
            <textarea [(ngModel)]="newItemRequest.description" rows="3" placeholder="Jelaskan mengapa barang ini dibutuhkan"></textarea>
          </div>
        </div>

        <div class="form-actions">
          <button class="btn btn-secondary" (click)="toggleNewItemForm()">Batal</button>
          <button 
            class="btn btn-primary" 
            (click)="submitNewItemRequest()"
            [disabled]="!newItemRequest.itemName || !newItemRequest.category || !newItemRequest.unit || !newItemRequest.requestedQuantity"
          >
            Kirim Request
          </button>
        </div>
      </div>
    </div>

    <!-- My Requests Section -->
    <div class="section-card">
      <div class="section-header">
        <h2>Riwayat Permintaan Barang yang Ada</h2>
      </div>

      <div class="requests-list">
        <div *ngFor="let request of myRequests" class="request-card">
          <div class="request-header">
            <div>
              <h3>Request #{{ request.id }}</h3>
              <p class="request-date">
                {{ request.createdAt | date:'dd/MM/yyyy HH:mm' }}
              </p>
            </div>
            <span class="badge" [ngClass]="getStatusBadgeClass(request.status)">
              {{ getStatusText(request.status) }}
            </span>
          </div>

          <div class="request-items">
            <h4>Barang yang Diminta:</h4>
            <ul>
              <li *ngFor="let item of request.items">
                {{ item.inventoryItemName }} - {{ item.quantity }} {{ getItemUnitFromRequest(item.inventoryItemId) }}
              </li>
            </ul>
          </div>

          <div *ngIf="request.notes" class="request-notes">
            <strong>Catatan Admin:</strong> {{ request.notes }}
          </div>

          <div *ngIf="request.updatedAt" class="request-updated">
            Diperbarui: {{ request.updatedAt | date:'dd/MM/yyyy HH:mm' }}
          </div>
        </div>

        <div *ngIf="myRequests.length === 0" class="empty-state">
          Belum ada permintaan yang dibuat
        </div>
      </div>
    </div>

    <!-- My New Item Requests Section -->
    <div class="section-card">
      <div class="section-header">
        <h2>Riwayat Request Barang Baru</h2>
      </div>

      <div class="requests-list">
        <div *ngFor="let request of myNewItemRequests" class="request-card">
          <div class="request-header">
            <div>
              <h3>New Item Request #{{ request.id }}</h3>
              <p class="request-date">
                {{ request.createdAt | date:'dd/MM/yyyy HH:mm' }}
              </p>
            </div>
            <span class="badge" [ngClass]="getStatusBadgeClass(request.status)">
              {{ getStatusText(request.status) }}
            </span>
          </div>

          <div class="request-items">
            <h4>Detail Barang yang Diminta:</h4>
            <ul>
              <li><strong>Nama:</strong> {{ request.itemName }}</li>
              <li><strong>Kategori:</strong> {{ request.category }}</li>
              <li><strong>Jumlah:</strong> {{ request.requestedQuantity }} {{ request.unit }}</li>
              <li *ngIf="request.description"><strong>Deskripsi:</strong> {{ request.description }}</li>
            </ul>
          </div>

          <div *ngIf="request.notes" class="request-notes">
            <strong>Catatan Admin:</strong> {{ request.notes }}
          </div>

          <div *ngIf="request.updatedAt" class="request-updated">
            Diperbarui: {{ request.updatedAt | date:'dd/MM/yyyy HH:mm' }}
          </div>
        </div>

        <div *ngIf="myNewItemRequests.length === 0" class="empty-state">
          Belum ada request barang baru
        </div>
      </div>
    </div>
  </div>
</div>
